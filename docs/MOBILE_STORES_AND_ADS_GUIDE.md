# Публикация в Google Play и App Store + монетизация рекламой

Краткий гайд по выводу приложения «Семейные Звёздочки» в мобильные магазины и заработку на рекламе. Всё по актуальным правилам и лучшим практикам (2024–2025).

---

## 1. Общая схема

```
[Ваш Next.js бэкенд]  ←  приложение в магазине подключается к нему по API
        ↑
[Мобильное приложение]
   - Android (Google Play)
   - iOS (App Store)
   - Внутри: реклама (AdMob и др.)
```

Сейчас у вас веб-приложение на Next.js. Чтобы оно оказалось в магазинах, нужен **мобильный клиент** (оболочка), который открывает ваш сайт или собранный веб-интерфейс и при необходимости показывает рекламу. Бэкенд (API, БД, авторизация) остаётся тем же.

---

## 2. Что уже сделано в проекте

В репозитории настроено:

- **Capacitor** — зависимости (`@capacitor/core`, `@capacitor/cli`, `@capacitor/android`, `@capacitor/ios`), плагин **@capacitor-community/admob**, конфиг `capacitor.config.ts`. Приложение в мобильной оболочке грузит ваш деплой по `CAPACITOR_SERVER_URL` (или localhost в dev).
- **Реклама для детей** — компонент `AdBanner` показывает баннер только в нативном приложении и только если у семьи нет подписки. Запросы к AdMob помечаются как детские: `tagForChildDirectedTreatment: true`, `tagForUnderAgeOfConsent: true`, `maxAdContentRating: "G"`.
- **Подписка «Без рекламы»** — в схеме БД у семьи есть поле `premiumUntil`. API `GET /api/subscription` возвращает статус подписки, `POST /api/subscription` (с заголовком `X-Subscription-Secret`) активирует подписку после покупки в приложении. Страница `/subscription` — экран подписки и кнопка покупки (в нативном приложении нужно подключить плагин IAP и вызывать этот API после успешной оплаты).

**Что сделать вам:** установить зависимости (`npm install`), добавить платформы (`npx cap add android`, `npx cap add ios`), в AdMob создать рекламные блоки для детского контента и прописать их ID в `NEXT_PUBLIC_ADMOB_BANNER_ID`. Для верификации подписки задать `SUBSCRIPTION_VERIFICATION_SECRET` и передавать его из нативного кода после покупки.

---

## 3. Как сделать мобильное приложение из Next.js

### Вариант A: Capacitor (оптимально для вашего кейса)

**Capacitor** — «обёртка» веб-приложения в нативную оболочку. Один веб-код (Next.js после экспорта или отдельный build) работает и в браузере, и в приложении из магазина.

- Плюсы: не нужно переписывать логику на React Native; доступ к нативным возможностям (push, хранилище, при необходимости камера); публикация в оба магазина из одной кодовой базы.
- Минусы: нужна настройка экспорта Next.js под статику (или отдельный фронт для мобилки), Xcode (macOS) для сборки iOS.

**Основные шаги:**

1. Установить Capacitor: `@capacitor/core`, `@capacitor/cli`, `@capacitor/android`, `@capacitor/ios`.
2. В `next.config` включить экспорт под статику: `output: 'export'` (или использовать гибридный подход: мобильное приложение грузит ваш деплой по URL).
3. Создать `capacitor.config.ts` (appId, URL вашего приложения или путь к статике).
4. Добавить платформы: `npx cap add android`, `npx cap add ios`.
5. Собирать: `next build` → `npx cap sync` → открыть проект в Android Studio / Xcode и собрать APK/IPA для магазинов.

Подробные туториалы: [Capacitor + Next.js](https://capgo.app/blog/nextjs-mobile-app-capacitor-from-scratch/), [Next.js to mobile](https://nextnative.dev/tutorials/convert-nextjs-to-mobile-app).

### Вариант B: PWA (Progressive Web App)

Сделать из текущего Next.js приложения PWA (manifest, service worker) и при желании отправить в магазины через **TWA** (Android) и **PWA in App Store** (ограниченная поддержка Apple). Меньше контроля над нативным UX и рекламой, но быстрее старт. Для серьёзной монетизации рекламой и доверия магазинов чаще выбирают именно нативную оболочку (Capacitor).

### Вариант C: React Native

Полноценное нативное приложение на React Native, которое дергает ваш существующий API. Максимальная гибкость и производительность, но по сути второй фронтенд — имеет смысл, если планируете отдельную команду под мобилки или очень сложный мобильный UX.

**Рекомендация:** для монетизации рекламой и публикации в оба магазина при текущем стеке (Next.js) разумнее всего **Capacitor**: один фронт, встроенная реклама через нативные SDK в оболочке, соответствие требованиям магазинов.

### Первый запуск Capacitor в этом проекте

1. Установить зависимости: `npm install`
2. Инициализировать Capacitor (если ещё не сделано): `npx cap init` (appId и appName уже заданы в `capacitor.config.ts`)
3. Добавить платформы: `npx cap add android`, `npx cap add ios`
4. Запустить веб-приложение (например, `npm run dev`) и задать URL в `capacitor.config.ts` или через `CAPACITOR_SERVER_URL` (для телефона в той же сети — IP компьютера и порт, например `http://192.168.1.10:3000`)
5. Синхронизировать: `npx cap sync`
6. Открыть нативные проекты: `npx cap open android` / `npx cap open ios`, собрать и запустить на устройстве или эмуляторе

---

## 4. Регистрация в магазинах

### Google Play

- **Регистрация:** [Google Play Console](https://play.google.com/console). Нужен аккаунт Google.
- **Стоимость:** разовый взнос **$25** (однажды за аккаунт разработчика).
- **Требования:** согласие с политиками, заполнение профиля разработчика, при первой публикации — проверка личности (по правилам Google).
- **Контент:** приложение должно соответствовать [Политике программы разработчиков](https://support.google.com/googleplay/android-developer/answer/10788890) и [Политике в отношении семей и детей](https://support.google.com/googleplay/android-developer/answer/9893335), если приложение ориентировано на семьи/детей.

### Apple App Store

- **Регистрация:** [Apple Developer Program](https://developer.apple.com/programs/). Нужен Apple ID.
- **Стоимость:** **$99 в год** (в рублях по курсу Apple).
- **Требования:** согласие с лицензией, заполнение данных организации/физлица; для iOS-сборки нужен Mac с Xcode (или облачная сборка, например через CI).
- **Ревью:** каждое приложение и обновление проходят [App Review](https://developer.apple.com/app-store/review/) (приватность, безопасность, контент). Перед отправкой полезно пройти [Human Interface Guidelines](https://developer.apple.com/design/human-interface-guidelines/) и [App Store Review Guidelines](https://developer.apple.com/app-store/guidelines/).
- **Сборки:** с апреля 2025 года приложения должны собираться с Xcode 16+ (iOS 18 SDK). Актуальные требования: [Upcoming Requirements](https://developers.apple.com/news/upcoming-requirements).

Итого по деньгам: **$25 один раз (Google)** + **$99 в год (Apple)**. Комиссии с продаж/подписок — отдельно (15–30% в зависимости от программы и региона).

---

## 5. Монетизация рекламой: лучшие практики

### Выбор сети

- **Google AdMob** — стандартный выбор для Android и iOS: баннеры, межстраничная (interstitial), нативная и **вознаграждаемая** реклама. Есть [руководство по внедрению](https://support.google.com/admob/answer/2936217).
- Для семейных приложений у Google есть [Families Self-Certified Ads SDK](https://support.google.com/googleplay/android-developer/answer/9900633) — использование одобренных рекламных SDK, соответствующих политике для семейного контента.

### Где показывать рекламу

- В **естественных паузах**: после выполнения задания, между экранами, при переходе из раздела в раздел — не в момент ввода пароля и не поверх критичного контента.
- **Не** призывать нажимать на рекламу и **не** давать награды за клики по рекламе — это нарушает политики и может привести к блокировке аккаунта.
- Баннеры лучше закреплять в одном месте (например, внизу экрана), чтобы контент не «прыгал». Рекомендуется не обновлять баннер чаще чем раз в 60 секунд.
- Использовать актуальные SDK AdMob (и медиацию при необходимости), запрашивать корректные размеры баннеров под ориентацию экрана.

### Технически

- Подключать рекламу в **нативной части** приложения (Capacitor/React Native), а не только в веб-вью, чтобы соблюдать требования магазинов и корректно использовать идентификаторы (например, для ограничения таргетинга по возрасту).
- Не делать запросы рекламы при выключенном экране.
- В приложении для семей/детей — см. раздел ниже (COPPA и политики семейного контента).

---

## 6. Семейные и детские приложения: COPPA и политики магазинов

«Семейные Звёздочки» — семейное приложение, возможна аудитория до 13 лет. Это накладывает ограничения.

### COPPA (США) и аналоги

- Не собирать персональные данные детей без согласия родителей (или не собирать их вовсе в детском контексте).
- Не использовать поведенческую рекламу (interest-based) для пользователей до 13 лет. В AdMob можно помечать запросы как [child-directed](https://support.google.com/publisherpolicies/answer/10436800) и отключать персонализацию.
- Не передавать в рекламные сети идентификаторы и данные, позволяющие отслеживать детей (IP, геолокация и т.д. — по правилам Google/Apple для детского контента).

### Google Play: семьи и дети

- Если приложение направлено на детей или привлекает детей, нужно соблюдать [Политику в отношении семей и детей](https://support.google.com/googleplay/android-developer/answer/9893335).
- Реклама в таких приложениях — только через одобренные решения, например [Families Self-Certified Ads SDK Program](https://support.google.com/googleplay/android-developer/answer/9900633).
- В карточке приложения указывается возрастной рейтинг и целевая аудитория.

### Apple App Store

- В [App Store Review Guidelines](https://developer.apple.com/app-store/guidelines/) есть раздел про приложения для детей (например, 1.3, 5.1.4).
- Ожидается соответствие правилам о конфиденциальности и рекламе в детском контексте; при необходимости — возрастной рейтинг и описание для родителей.

**Практический вывод:**  
Для монетизации рекламой в семейном приложении:

1. Чётко определить в настройках магазинов: приложение для семей / с возможным присутствием детей.
2. Использовать только одобренные для семейного контента рекламные SDK (например, через программу Families в Google).
3. Отключить таргетинг по интересам и сбор личных данных для детской аудитории; в AdMob корректно настроить теги child-directed.
4. В политике конфиденциальности и на экране приложения явно описать, какая реклама показывается и как обрабатываются данные детей (если применимо).

---

## 7. Подписка «Без рекламы»

- Пользователь может купить подписку в мобильном приложении (Google Play Billing / App Store In-App Purchase). Одна подписка на **семью** — реклама отключается у всех участников.
- После успешной покупки нативное приложение вызывает `POST /api/subscription` с заголовком `X-Subscription-Secret: <SUBSCRIPTION_VERIFICATION_SECRET>` (и при необходимости передаёт токен покупки для серверной верификации). Бэкенд обновляет у семьи поле `premiumUntil`.
- На фронте компонент `AdBanner` запрашивает `GET /api/subscription` и не показывает рекламу, если `premium === true`. Страница `/subscription` отображает статус подписки и кнопку покупки (в приложении — вызов нативного IAP).
- Для полноценной продакшен-верификации нужно добавить проверку чека через [Google Play Developer API](https://developers.google.com/android-publisher) (Android) и [App Store Server API](https://developer.apple.com/documentation/appstoreserverapi) (iOS) и только после успешной проверки вызывать обновление `premiumUntil`.

---

## 8. Пошаговый план (чеклист)

Упрощённый порядок действий:

| # | Шаг | Заметки |
|---|-----|--------|
| 1 | Зарегистрироваться в Google Play Console | $25 один раз |
| 2 | Зарегистрироваться в Apple Developer Program | $99/год, нужен Mac для сборки iOS |
| 3 | Подготовить Next.js под мобильную оболочку | Статический экспорт или единый URL для WebView |
| 4 | Добавить Capacitor, собрать Android и iOS проекты | Локально или через CI |
| 5 | Интегрировать рекламу (AdMob) в нативную оболочку | В проекте уже есть AdBanner с детскими тегами; создать блоки в AdMob и указать ID |
| 6 | Настроить политику конфиденциальности и, при необходимости, согласие на рекламу | URL политики понадобится в карточках приложений |
| 7 | Подготовить материалы для магазинов | Иконка, скриншоты, описание, возрастной рейтинг |
| 8 | Собрать релизные сборки | Android: AAB (Android App Bundle); iOS: IPA через Xcode/архив |
| 9 | Отправить в Google Play | Заполнить карточку, указать «Семья»/возраст, пройти модерацию |
| 10 | Отправить в App Store Connect | Метаданные, скриншоты, возрастной рейтинг, App Review |
| 11 | После публикации | Следить за отзывами, обновлять под новые требования SDK и магазинов |

---

## 9. Полезные ссылки

- [Google Play Console](https://play.google.com/console)  
- [Apple Developer Program](https://developer.apple.com/programs/)  
- [App Store Review Guidelines](https://developer.apple.com/app-store/guidelines/)  
- [Google Play policy (families)](https://support.google.com/googleplay/android-developer/answer/9893335)  
- [AdMob: Implementation guidance](https://support.google.com/admob/answer/2936217)  
- [AdMob: Monetization guide](https://admob.google.com/home/resources/non-nonsense-guide-to-app-monetization-google-admob)  
- [Capacitor + Next.js](https://capgo.app/blog/nextjs-mobile-app-capacitor-from-scratch/)  
- [COPPA and Google](https://support.google.com/publisherpolicies/answer/10436800)  

---

Итог: вы делаете мобильное приложение (рекомендуется Capacitor поверх текущего Next.js), подключаете рекламу через AdMob с учётом правил для семейных приложений, регистрируетесь в магазинах ($25 + $99/год) и проходите модерацию с корректным возрастным рейтингом и политикой конфиденциальности. Если нужно, следующий шаг — разобрать конкретно интеграцию Capacitor в ваш репозиторий или выбор форматов рекламы под экраны приложения.
