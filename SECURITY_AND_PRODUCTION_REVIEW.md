# Ревью безопасности и готовности к продакшену / монетизации

**Проект:** Family Stars  
**Дата ревью:** 2025-02-08  
**Цель:** Оценка текущего состояния и план перехода к безопасному приложению, готовому к мобильной монетизации.

---

## Краткий вердикт

Сейчас проект выглядит как **прототип для разработки**, а не как защищённое продакшен-приложение. На бесплатном Neon это допустимо для теста, но для платного мобильного продукта нужны существенные изменения по безопасности, изоляции данных и инфраструктуре.

Ниже — что уже есть, что опасно и что нужно сделать.

---

## 1. Критические уязвимости (исправить в первую очередь)

### 1.1 API без авторизации — полный доступ к данным и уничтожение БД

Следующие маршруты **вообще не проверяют сессию** и доступны любому, кто знает URL:

| Маршрут | Метод | Риск |
|--------|--------|------|
| `/api/wipe-database` | DELETE | **Удаление всех пользователей и семей** |
| `/api/init-admin` | GET/POST | Создание админа с паролем `admin2024` |
| `/api/init-content` | POST | Добавление задач/подарков в общую БД |
| `/api/reset-content` | POST | **Удаление всех задач и подарков**, пересоздание контента |
| `/api/create-schema` | GET | Выполнение сырого SQL по схеме БД |
| `/api/debug-users` | GET | **Список всех пользователей** (id, name, role, points, даты) |
| `/api/debug-family` | GET | **Список всех семей** с админами и участниками (сессия импортирована, но не вызывается) |
| `/api/test-db` | — | Проверка БД (утечка информации о подключении при ошибках) |
| `/api/migrate`, `/api/add-family-system`, `/api/fix-parent-child` и др. | — | Миграции/фиксы без проверки прав |

**Рекомендации:**

- В продакшене **полностью отключить или удалить** debug/init/wipe/migrate/create-schema маршруты из публичного приложения.
- Если такие эндпоинты нужны только для админки:
  - Вынести их в отдельный сервис/скрипт (например, только по SSH или в закрытой сети).
  - Либо защищать строгой проверкой: например, секретный заголовок/ключ + проверка, что вызывающий — суперадмин с БД.
- Никогда не оставлять в коде продакшена эндпоинты типа `wipe-database` и `init-admin` без жёсткой защиты.

### 1.2 Утечка данных через `/api/login-users`

- При запросе **без** `familyCode` возвращаются **все пользователи** (id, name, role, points, gender).
- Достаточно вызвать `GET /api/login-users` без параметров — и получить список всех пользователей приложения.

**Рекомендация:**  
Либо убрать ветку без `familyCode`, либо возвращать только публичную информацию (например, только имена для выбора под текущую семью), без id и ролей в открытом виде. В идеале — требовать код семьи и отдавать только членов этой семьи.

### 1.3 Регистрация семьи и токен первого входа

- `/api/register-family` по дизайну публичный — это нормально.
- Но в ответе возвращается **полная ссылка первого входа с токеном**:  
  `firstLoginUrl` с `token=...` в query.
- Если ответ перехватывается (логи, прокси, небезопасный клиент), токен достаточен для смены пароля через `/api/change-password-by-token`.

**Рекомендации:**

- Не отдавать длинноживущий токен в URL в ответе API. Отправлять ссылку на первый вход по email (если будет email-отправка) или показывать одноразовый код только в UI и не логировать его.
- Токен первого входа делать одноразовым и с коротким TTL (например, 15–60 минут).

---

## 2. Изоляция данных между семьями (мультитенантность)

Сейчас данные между семьями **не изолированы**:

- **`/api/statistics`** — по роли PARENT/FAMILY_ADMIN возвращает статистику по **всем** пользователям с ролью CHILD в БД, а не только по детям своей семьи.
- **`/api/users`** (GET) — возвращает **всех** детей в системе, не только из семьи текущего родителя.
- Модели **Task** и **Gift** не привязаны к семье (`familyId` нет) — все семьи видят один общий набор задач и подарков. Для мультитенанта это неверно: каждая семья должна иметь свой набор или явно общий каталог с изоляцией доступа по семье.

**Рекомендации:**

- Во всех эндпоинтах, где фигурируют «дети» или «родители», фильтровать по `familyId` текущего пользователя (или по семье, к которой он привязан).
- Для статистики: только дети из той же семьи, что и текущий пользователь.
- Для списка пользователей (родительская панель): только участники своей семьи.
- Решить модель данных: задачи/подарки на семью (добавить `familyId` в Task/Gift и везде фильтровать) или общий каталог с доступом только через проверку семьи.

---

## 3. Аутентификация и сессии

- Используется **NextAuth** с провайдером **Credentials** (логин/пароль). Это нормально для веба.
- Для **мобильных приложений** cookie-сессии не всегда удобны: нужен сценарий с долгоживущим токеном (JWT или refresh token), который мобильный клиент хранит и передаёт в заголовке.
- В `env.example` указан пример секрета `super_secret_key_...` — в продакшене **обязательно** свой криптостойкий `NEXTAUTH_SECRET`, хранящийся только в переменных окружения (не в репозитории).
- Нет 2FA, нет OAuth (Google/Apple) — для мобильной монетизации часто нужен хотя бы «Войти через Apple» / «Войти через Google».

**Рекомендации:**

- Оставить NextAuth для веба; для мобильных клиентов добавить отдельный поток: выдача JWT (или пары access/refresh) после проверки логина/пароля или OAuth, защищённые эндпоинты проверяют этот токен.
- Установить в продакшене сильный `NEXTAUTH_SECRET` и не коммитить его.
- Планировать OAuth (Apple/Google) для мобильных пользователей и, при необходимости, 2FA для родителей/админов.

---

## 4. Инфраструктура и конфигурация

- **База:** бесплатный Neon (PostgreSQL) — для продакшена с доходом лучше платный план (лимиты, бэкапы, SLA).
- **Нет middleware** в Next.js — нет единой точки проверки авторизации для API и страниц.
- **Нет rate limiting** — возможны брутфорс паролей и DDoS по API.
- **Нет явных security headers** (CSP, HSTS, X-Frame-Options и т.д.) в `next.config.mjs` или через middleware.
- В коде местами логируются чувствительные действия (например, смена пароля с именем пользователя) — в продакшене лучше убрать или заменить на id без PII.

**Рекомендации:**

- Добавить `middleware.ts`: проверка сессии для защищённых путей, при необходимости — базовая проверка JWT для API.
- Включить rate limiting (например, по IP и по пользователю) на логин и чувствительные API.
- Настроить security headers (Next.js или через Vercel/прокси).
- Перейти на платный Neon (или другой managed PostgreSQL) с бэкапами.
- Вынести все секреты в переменные окружения; не хранить их в репозитории.

---

## 5. Мобильная монетизация

Чтобы приложение могло приносить доход через мобильные платформы, помимо безопасности нужно учесть:

- **Платформы:** отдельные клиенты (React Native / Expo, Flutter и т.д.) или PWA с ограничениями по платежам и нативным функциям.
- **Платежи:** если планируются подписки или разовые покупки — интеграция с App Store / Google Play (IAP) и, при необходимости, бэкенд для верификации чеков и привязки подписки к `userId`/семье.
- **Политики магазинов:** политика конфиденциальности, обработка данных детей (COPPA, GDPR и т.д.), если приложение ориентировано на семьи с детьми.
- **Идентификация пользователя в API:** единый аккаунт для веба и мобилок (тот же бэкенд), авторизация через токен для мобильных клиентов.

Сейчас в проекте нет ни эндпоинтов под подписки/IAP, ни отдельной мобильной авторизации — это следующий шаг после закрытия критических дыр.

---

## 5.1 Замечание по коду

В `src/app/api/user-tasks/route.ts` в POST (выполнение задачи) транзакция оформлена с лишней закрывающей скобкой: блок `tx.userTask.create` закрывается `});`, после чего идёт `tx.user.update`. С точки зрения скобок код может работать, но структура читается запутанно — стоит перепроверить, что и создание UserTask, и начисление баллов действительно выполняются в одной транзакции и при ошибке откатываются вместе.

---

## 6. Что уже сделано неплохо

- Пароли хранятся в виде хеша (bcryptjs).
- Часть API проверяет сессию и роль (users, tasks, gifts, profile, manage-family, statistics и др.).
- Есть роли (CHILD, PARENT, FAMILY_ADMIN) и семейная модель (Family, inviteCode).
- Регистрация семьи и первый вход через одноразовый токен — идея правильная, нужно только не светить токен в ответах и ограничить TTL.

---

## 7. План действий (приоритеты)

| Приоритет | Действие |
|-----------|----------|
| P0 | Отключить или жёстко защитить: wipe-database, init-admin, init-content, reset-content, create-schema, debug-*, migrate, test-db и аналоги. |
| P0 | Убрать утечку в login-users: не возвращать всех пользователей без familyCode или сузить объём данных. |
| P0 | Ввести изоляцию по семье: statistics и users только по своей семье; при необходимости добавить familyId в Task/Gift и фильтровать везде. |
| P1 | Добавить middleware для защиты маршрутов и, при необходимости, проверки JWT для мобильного API. |
| P1 | Настроить NEXTAUTH_SECRET и security headers; убрать чувствительные логи. |
| P1 | Сделать токен первого входа одноразовым и с TTL; не отдавать полный URL с токеном в теле API-ответа. |
| P2 | Rate limiting на логин и критические API. |
| P2 | Платный план БД, бэкапы. |
| P2 | Подготовка к мобильным клиентам: отдельный поток выдачи JWT, при необходимости OAuth (Apple/Google). |
| P3 | Монетизация: дизайн подписок/IAP, эндпоинты верификации и привязки к пользователю/семье. |

---

## 8. Итог

Проект имеет хорошую основу (модель семьи, роли, хеш паролей), но в текущем виде **не готов к использованию как защищённое и монетизируемое мобильное приложение**: открытые опасные эндпоинты, утечка данных пользователей, отсутствие изоляции между семьями и отсутствие инфраструктурных мер (rate limit, заголовки, отдельная мобильная авторизация).

После выполнения пунктов P0 и P1 приложение станет существенно безопаснее и ближе к формату «настоящего» продукта; P2–P3 доведут его до состояния, пригодного для мобильной монетизации и платного хостинга БД.

Если нужно, могу предложить конкретные патчи (например, список изменений по файлам) по приоритету P0.

---

## 9. Применённые изменения (защищённая версия)

Ниже перечень изменений, которые были внедрены в проект.

- **Опасные API** защищены через `requireAdmin(request)`: доступ только с заголовком `X-Admin-Key: <ADMIN_SECRET>`. В продакшене без `ADMIN_SECRET` эти эндпоинты возвращают 404.
- **Singleton Prisma** (`src/lib/prisma.ts`) используется во всех API вместо создания нового клиента в каждом запросе.
- **SSO**: добавлены провайдеры Google и Apple в NextAuth (включаются при наличии `GOOGLE_CLIENT_ID/SECRET` и `APPLE_ID/SECRET`). Сессия расширена полями `familyId` и `email`.
- **login-users**: обязателен параметр `familyCode`; без него возвращается 400.
- **Изоляция по семье**: в `statistics` и `users` данные фильтруются по `familyId` текущего пользователя. В `users` при создании/обновлении/удалении проверяется принадлежность к той же семье.
- **Task/Gift**: в схему добавлено поле `familyId`; в API задачи и подарки фильтруются по глобальным (`familyId: null`) и по семье пользователя; создание и изменение привязаны к семье.
- **Токен первого входа**: в БД добавлено поле `tempPasswordExpiresAt` (TTL 24 ч); в `change-password-by-token` проверяется срок действия; в продакшене ссылка с токеном не возвращается в ответе `register-family`.
- **Middleware** (`src/middleware.ts`): защита маршрутов `/dashboard`, `/parent`, `/child`, `/tasks`, `/gifts`; добавлены security-заголовки (X-Frame-Options, X-Content-Type-Options, Referrer-Policy, HSTS в production).
- **env.example** обновлён: описание `NEXTAUTH_SECRET`, `ADMIN_SECRET`, переменных для Google/Apple SSO.

**Удобство и навигация:**
- На главной странице добавлена явная ссылка «Зарегистрировать семью» и «Вход в семью».
- На странице входа — ссылки «На главную» и «Регистрация семьи».
- На странице регистрации — «Войти» и «На главную»; после создания семьи в production (без firstLoginUrl) показывается кнопка «Перейти к входу и создать пароль».
- Валидация: минимальная длина пароля при создании пользователя (6–128 символов), ограничение длины имени (100 символов).

**Перед запуском** выполните миграцию БД и задайте переменные окружения:

```bash
npx prisma migrate dev --name add_security_and_family_tasks
# либо npx prisma db push  # если не используете миграции
```

В `.env.local` (или в настройках хостинга) задайте как минимум `NEXTAUTH_SECRET` и `DATABASE_URL`. Для SSO добавьте `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET` и при необходимости `APPLE_ID`, `APPLE_SECRET` (см. `env.example`).
