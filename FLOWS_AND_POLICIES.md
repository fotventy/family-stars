# Алгоритмы приложения и политики (Google / Apple)

## 1. Что видит человек, перешедший по маркетинговой ссылке

Пользователь попадает на **главную страницу** (например, по рекламе или постам). Там он видит:

1. **Блок «Перешли по ссылке? Вот что делать»** — пошаговая инструкция:
   - Зарегистрировать семью (кнопка «Создать семью»).
   - Задать пароль по ссылке из письма или на странице входа.
   - По желанию включить 2FA после входа.
   - Добавить жену/мужа и детей — каждому появится ссылка; отправьте её удобным способом (скопировать и вставить в мессенджер, соцсеть, SMS или указать email — приглашение дублируется на почту).

2. **Кнопки действий:**
   - **Создать семью** — переход на `/register-family`.
   - **Войти в семью** — переход на `/login`.

3. **Ссылки внизу:** «Зарегистрировать семью», «Вход в семью».

---

## 2. Регистрация семьи и себя как админа

1. Пользователь нажимает **«Создать семью»** → страница `/register-family`.
2. Заполняет: название семьи, имя первого родителя, кто админ (папа/мама), **email**.
3. Отправка формы → создаётся семья и первый пользователь (роль **FAMILY_ADMIN**), генерируется одноразовая ссылка для первого входа (TTL 24 часа).
4. В **development** в ответе возвращается `firstLoginUrl` — админ переходит по ней. В **production** ссылка не отдаётся в JSON (можно доработать отправку этой ссылки на email админа).
5. Переход по ссылке первого входа → страница `/first-login` (token + user в URL). Пользователь вводит и подтверждает пароль → запрос `POST /api/change-password-by-token` → автоматический вход → **редирект на `/welcome`**.

---

## 3. Предложение 2FA и доступ к сайту

1. После первого входа (в т.ч. по ссылке первого входа) пользователь попадает на **`/welcome`**.
2. На странице приветствия:
   - Текст о том, что аккаунт создан и рекомендуется усилить защиту.
   - **«Включить 2FA»** → переход на `/settings/security`.
   - **«Пропустить и перейти в приложение»** → переход в кабинет: родитель → `/parent`, ребёнок → `/child`.
3. Страница **`/settings/security`** пока реализована как заглушка: сообщение, что 2FA «скоро» будет доступна, и рекомендация использовать надёжный пароль или вход через Google/Apple. Полноценный TOTP (Google Authenticator и т.п.) можно добавить на следующем этапе.
4. Итог: **доступ к сайту** пользователь получает сразу после первого входа (пароль задан); 2FA **предлагается**, но не обязательна.

---

## 4. Добавление жены/мужа и детей — ссылка, которую админ отправляет удобным способом

1. Админ семьи заходит в кабинет (родительский интерфейс) и открывает **«Управление семьёй»** (модальное окно).
2. Нажимает **«Добавить члена семьи»** и заполняет форму:
   - **Имя** (обязательно),
   - **Роль** (ребёнок / родитель),
   - **Пол** (папа/мама или сын/дочь),
   - **Email** (необязательно — если указать, приглашение дополнительно уйдёт на почту).
3. Отправка → `POST /api/manage-family` с полями `name`, `role`, `gender`, `email`.
4. Бэкенд создаёт пользователя в семье и одноразовую ссылку первого входа (TTL 7 дней). Если передан email и настроена отправка (Resend) — дублирует приглашение на почту.
5. В интерфейсе после добавления админ видит **ссылку для приглашения** и кнопку **«Копировать ссылку»**. Подсказка: «Скопируйте ссылку и вставьте в мессенджер, соцсеть, SMS или перешлите в любом приложении». Если письмо отправлено — отображается «Копия приглашения также отправлена на почту».
6. Приглашённый переходит по ссылке (из мессенджера, письма, SMS — как админ отправил) → `/first-login` → задаёт пароль → вход → редирект на `/welcome`, далее в кабинет.

**Итог:** основное — **ссылка, которую админ может скопировать и отправить удобным ему способом** (другое приложение, мессенджер, просто скопировать). Email опционален: при указании email приглашение дополнительно отправляется на почту.

---

## 5. Правила Google и Apple: приглашения по email

- **Кнопки «Войти через Google» и «Войти через Apple»** регулируются правилами OAuth и политиками магазинов (Google Play, App Store). Эти правила **не требуют** именно того, чтобы приглашения в «семью» отправлялись по email. То есть технически приглашение можно отдавать только в интерфейсе (копировать ссылку) — этого достаточно для соответствия SSO/магазинам.
- Для **семейных и детских приложений** часто рекомендуют:
  - явное приглашение в семью (у нас есть ссылка с ограниченным сроком действия);
  - возможность идентификации приглашённого (email, ссылка с токеном);
  - прозрачность для пользователя (кто пригласил, куда входит).
- **Отправка приглашения на email** — это не обязанность по правилам Google/Apple для SSO, а **хорошая практика и ожидание пользователей**: «указал email — приглашение должно прийти на почту». В приложении это реализовано: при указании email при добавлении члена семьи письмо с ссылкой уходит (если настроен Resend). Так мы и соблюдаем ваше правило «для всех них должна быть отправлена ссылка на почту для регистрации в семью», и делаем поведение предсказуемым для пользователей и ревью магазинов.

---

## 6. Краткая схема потоков

| Шаг | Действие | Результат |
|-----|----------|------------|
| 1 | Переход по маркетинговой ссылке | Главная с блоком «Что делать» и кнопками Создать семью / Войти |
| 2 | Регистрация семьи (название, админ, email) | Семья и админ созданы, ссылка первого входа (в dev — в ответе; в prod — можно доработать отправку на email) |
| 3 | Переход по ссылке первого входа, ввод пароля | Пароль сохранён, вход выполнен, редирект на `/welcome` |
| 4 | На странице Welcome | Предложение 2FA и кнопка «Пропустить» → переход в кабинет (`/parent` или `/child`) |
| 5 | В кабинете: Управление семьёй → Добавить члена (имя, роль, пол, email по желанию) | Пользователь создан; админ видит ссылку и кнопку «Копировать ссылку» — отправляет удобным способом; при указании email приглашение дублируется на почту |
| 6 | Приглашённый переходит по ссылке (мессенджер, почта, SMS — как админ отправил) | `/first-login` → пароль → вход → `/welcome` → кабинет |

---

## 7. Настройка отправки писем

Чтобы приглашения реально уходили на почту:

1. Зарегистрироваться в [Resend](https://resend.com), получить API Key.
2. В проекте задать переменные окружения (например в `.env.local` или в настройках хостинга):
   - `RESEND_API_KEY=re_...`
   - `EMAIL_FROM=Семейные Звёздочки <noreply@ваш-домен.com>` (для продакшена желательно верифицировать домен в Resend).
3. При добавлении члена семьи указывать email — письмо с ссылкой будет отправляться автоматически.

Без `RESEND_API_KEY` приложение продолжает работать: ссылка для приглашения по-прежнему создаётся и показывается в интерфейсе, админ может скопировать её и отправить вручную (мессенджер, соцсети и т.д.).
